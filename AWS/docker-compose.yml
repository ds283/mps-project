version: '3'

services:

  web:

    image: 801384587375.dkr.ecr.eu-west-1.amazonaws.com/mpsproject:latest
    environment:
      - DATABASE_URL=mysql+pymysql://mpsproject:Bridle12Way2007@mariadb/mpsproject
      - CELERY_RESULT_BACKEND=redis://redis:6379
      - CELERY_BROKER_URL=redis://redis:6379
      - BACKUP_FOLDER=/home/mpsproject/backups
      - DATABASE_USER=mpsproject
      - DATABASE_PASSWORD=Bridle12Way2007
      - DATABASE_ROOT_PASSWORD=Wilberforce2008Road
      - DATABASE_HOSTNAME=mariadb
      - SESSION_MONGO_URL=mongodb://mpsproject:Bridle12Way2007@mongodb:27017
      - CACHE_REDIS_URL=redis://redis:6379
      - RATELIMIT_REDIS_URL=redis://redis:6379
      - PROFILER_MONGODB_URL=mongodb://mpsproject:Bridle12Way2007@mongodb:27017
      - PROFILER_MONGODB_DATABASE=flask_profiler
      - LOG_FILE=/home/mpsproject/logs/mps_project.log
    volumes:
      - /data/mpsproject/instance:/home/mpsproject/instance
      - /data/mpsproject/backups:/home/mpsproject/backups
      - /data/mpsproject/logs:/home/mpsproject/logs
    links:
      - mariadb
      - redis
      - mongodb
    logging:
      driver: awslogs
      options:
        awslogs-group: mps-project
        awslogs-region: eu-west-1
        awslogs-stream-prefix: web

  nginx:

    image: 801384587375.dkr.ecr.eu-west-1.amazonaws.com/nginx:latest
    environment:
      - API_KEY='8e8116d37510b15b73aa5f9ec3246884'
    ports:
      - '80:8000'
      - '443:443'
    volumes:
      - /data/mpsproject/logs:/home/mpsproject/logs
    links:
      - web
      - flower
    logging:
      driver: awslogs
      options:
        awslogs-group: mps-project
        awslogs-region: eu-west-1
        awslogs-stream-prefix: nginx

  worker:

    image: 801384587375.dkr.ecr.eu-west-1.amazonaws.com/mpsproject:latest
    entrypoint: "./launch_celery.sh"
    user: mpsproject
    environment:
      - DATABASE_URL=mysql+pymysql://mpsproject:Bridle12Way2007@mariadb/mpsproject
      - CELERY_RESULT_BACKEND=redis://redis:6379
      - CELERY_BROKER_URL=redis://redis:6379
      - BACKUP_FOLDER=/home/mpsproject/backups
      - DATABASE_USER=mpsproject
      - DATABASE_PASSWORD=Bridle12Way2007
      - DATABASE_ROOT_PASSWORD=Wilberforce2008Road
      - DATABASE_HOSTNAME=mariadb
      - CACHE_REDIS_URL=redis://redis:6379
      - RATELIMIT_REDIS_URL=redis://redis:6379
      - PROFILER_MONGODB_URL=mongodb://mpsproject:Bridle12Way2007@mongodb:27017
      - PROFILER_MONGODB_DATABASE=flask_profiler
      - LOG_FILE=/home/mpsproject/logs/mps_project.log
    volumes:
      - /data/mpsproject/instance:/home/mpsproject/instance
      - /data/mpsproject/backups:/home/mpsproject/backups
      - /data/mpsproject/logs:/home/mpsproject/logs
    links:
      - mariadb
      - redis
      - mongodb
    logging:
      driver: awslogs
      options:
        awslogs-group: mps-project
        awslogs-region: eu-west-1
        awslogs-stream-prefix: worker

  scheduler:

    image: 801384587375.dkr.ecr.eu-west-1.amazonaws.com/mpsproject:latest
    entrypoint: "./launch_beat.sh"
    user: mpsproject
    environment:
      - DATABASE_URL=mysql+pymysql://mpsproject:Bridle12Way2007@mariadb/mpsproject
      - CELERY_RESULT_BACKEND=redis://redis:6379
      - CELERY_BROKER_URL=redis://redis:6379
      - CACHE_REDIS_URL=redis://redis:6379
      - RATELIMIT_REDIS_URL=redis://redis:6379
      - PROFILER_MONGODB_URL=mongodb://mpsproject:Bridle12Way2007@mongodb:27017
      - PROFILER_MONGODB_DATABASE=flask_profiler
      - LOG_FILE=/home/mpsproject/logs/mps_project.log
    volumes:
      - /data/mpsproject/instance:/home/mpsproject/instance
      - /data/mpsproject/logs:/home/mpsproject/logs
    links:
      - mariadb
      - redis
      - mongodb
    logging:
      driver: awslogs
      options:
        awslogs-group: mps-project
        awslogs-region: eu-west-1
        awslogs-stream-prefix: scheduler

  flower:

    image: 801384587375.dkr.ecr.eu-west-1.amazonaws.com/mpsproject:latest
    entrypoint: "./launch_flower.sh"
    user: mpsproject
    environment:
      - DATABASE_URL=mysql+pymysql://mpsproject:Bridle12Way2007@mariadb/mpsproject
      - CELERY_RESULT_BACKEND=redis://redis:6379
      - CELERY_BROKER_URL=redis://redis:6379
      - CACHE_REDIS_URL=redis://redis:6379
      - RATELIMIT_REDIS_URL=redis://redis:6379
      - PROFILER_MONGODB_URL=mongodb://mpsproject:Bridle12Way2007@mongodb:27017
      - PROFILER_MONGODB_DATABASE=flask_profiler
      - LOG_FILE=/home/mpsproject/logs/mps_project.log
    volumes:
      - /data/mpsproject/instance:/home/mpsproject/instance
      - /data/mpsproject/logs:/home/mpsproject/logs
    links:
      - mariadb
      - redis
      - worker
      - mongodb
    logging:
      driver: awslogs
      options:
        awslogs-group: mps-project
        awslogs-region: eu-west-1
        awslogs-stream-prefix: flower

  mariadb:

    # MySQL 8.0 uses a default authentication method that isn't supported by PyMySQLyet;
    # see https://github.com/PyMySQL/PyMySQL/issues/532, https://github.com/PyMySQL/PyMySQL/issues/651
    # this means we need to use 5.7 for the foreseeable future

    # use MariaDB 10.2 as a drop-in replacement for MySQL 5.2
    # we prefer MariaDB because there's better support for the client tools in the Linux
    # ecosystem; eg. we can install mysqldump in Alpine linux
    image: mariadb:10.2
    environment:
      - MYSQL_DATABASE=mpsproject
      - MYSQL_USER=mpsproject
      - MYSQL_PASSWORD=Bridle12Way2007
      - MYSQL_ROOT_PASSWORD=Wilberforce2008Road
    volumes:
      - /data/mpsproject/mysql/data:/var/lib/mysql
      - /data/mpsproject/mysql/conf.d:/etc/mysql
    logging:
      driver: awslogs
      options:
        awslogs-group: mps-project
        awslogs-region: eu-west-1
        awslogs-stream-prefix: mariadb

  redis:

    image: redis:latest
    logging:
      driver: awslogs
      options:
        awslogs-group: mps-project
        awslogs-region: eu-west-1
        awslogs-stream-prefix: redis

  mongodb:

    image: mongo:latest
    environment:
      - MONGO_INITDB_ROOT_USERNAME=mpsproject
      - MONGO_INITDB_ROOT_PASSWORD=Bridle12Way2007
      - MONGO_INITDB_DATABASE=flask_profiler
    ports:
      # export 27017; should be closed for production deployment
      - 27017:27017
    volumes:
      - /data/mpsproject/mongodb:/data/db
    logging:
      driver: awslogs
      options:
        awslogs-group: mps-project
        awslogs-region: eu-west-1
        awslogs-stream-prefix: mongodb
