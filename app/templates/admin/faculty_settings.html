{% import "bootstrap/wtf.html" as wtf %}
{% from "macros.html" import edit_data %}

{% extends "security/index.html" %}

{% block title %}
    Settings
{% endblock %}

{% block formtitle %}
    Edit my settings
{% endblock %}

{% block form_content %}
    <form action="{{ url_for('admin.faculty_settings') }}" method="POST" name="settings_form">

    {{ settings_form.hidden_tag() }}

{#        {{ wtf.form_errors(settings_form) }}#}

    <div class="well">
        {% if data and data.enrollments and data.enrollments.first() %}
            <p>You are currently enrolled for the following project classes</p>
            {% for record in data.enrollments %}
                {% if loop.index > 1 %}
                    <hr class="intro-divider">
                {% endif %}
                {% set pclass = record.pclass %}
                {% set style = pclass.make_CSS_style() %}
                <div class="row vertical-align">
                    <div class="col-xs-6">
                        <h4>
                            <a class="label {% if style %}label-default{% else %}label-info{% endif %} btn-table-block"
                               {% if style %}style="{{ style }}"{% endif %}
                               href="mailto:{{ pclass.convenor_email }}">
                                {{ pclass.name }} ({{ pclass.convenor_name }})
                            </a>
                        </h4>
                    </div>
                    <div class="col-xs-3">
                        Supervising:
                        {% if record.supervisor_state == record.SUPERVISOR_ENROLLED  %}
                            <span class="label label-primary"><i class="fa fa-check"></i> Enrolled</span>
                        {% elif record.supervisor_state == record.SUPERVISOR_SABBATICAL %}
                            <span class="label label-info"><i class="fa fa-times"></i> Sabbatical/Buyout</span>
                            {% if record.supervisor_reenroll is not none %}
                                <span class="label label-info">ends {{ record.supervisor_reenroll }}</span>
                            {% else %}
                                <span class="label label-warning">no end date</span>
                            {% endif %}
                        {% elif record.supervisor_state == record.SUPERVISOR_EXEMPT %}
                            <span class="label label-warning"><i class="fa fa-times"></i> Exempt</span>
                        {% else %}
                            <span class="label label-danger"><i class="fa fa-exclamation-triangle"></i> Error</span>
                        {% endif %}
                    </div>
                    <div class="col-xs-3">
                        {% if record.pclass.uses_marker %}
                            2nd-marking:
                            {% if record.marker_state == record.MARKER_ENROLLED %}
                                <span class="label label-primary"><i class="fa fa-check"></i> Enrolled</span>
                            {% elif record.marker_state == record.MARKER_SABBATICAL %}
                                <span class="label label-info"><i class="fa fa-times"></i> Sabbatical/Buyout</span>
                                {% if record.marker_reenroll is not none %}
                                    <span class="label label-info">ends {{ record.marker_reenroll }}</span>
                                {% else %}
                                    <span class="label label-warning">no end date</span>
                                {% endif %}
                            {% elif record.marker_state == record.MARKER_EXEMPT %}
                                <span class="label label-warning"><i class="fa fa-times"></i> Exempt</span>
                            {% else %}
                                <span class="label label-danger"><i class="fa fa-exclamation-triangle"></i> Error</span>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
            {% if data.enrollments.count() != project_classes.count() %}
                <hr class="intro-divider">
                <p>You are not currently enrolled for the following project classes</p>
                <h3>
                    {% for pclass in current_user.all_project_classes %}
                        {% if not data.is_enrolled(pclass) %}
                            <a class="btn btn-default btn-table-block" href="mailto:{{ pclass.convenor_email }}">
                                {{ pclass.name }} ({{ pclass.convenor_name }})
                            </a>
                        {% endif %}
                    {% endfor %}
                </h3>
            {% endif %}
        {% else %}
            <p>You are not currently enrolled for any project classes.
            The available classes are:</p>
            <h3>
                {% for pclass in project_classes %}
                    <a class="btn btn-default btn-table-block" href="mailto:{{ pclass.convenor_email }}">
                        {{ pclass.name }} ({{ pclass.convenor_name }})
                    </a>
                {% endfor %}
            </h3>
        {% endif %}
    </div>

    {{ wtf.form_field(settings_form.username) }}
    {{ wtf.form_field(settings_form.first_name) }}
    {{ wtf.form_field(settings_form.last_name) }}

    {{ wtf.form_field(settings_form.office) }}

    <div class="well">
        <p>Titles</p>
        {{ wtf.form_field(settings_form.academic_title) }}
        {{ wtf.form_field(settings_form.use_academic_title) }}
    </div>

    <div class="well">
        <p>Project defaults</p>
        {{ wtf.form_field(settings_form.sign_off_students) }}
        {{ wtf.form_field(settings_form.project_capacity) }}
        {{ wtf.form_field(settings_form.enforce_capacity) }}
        {{ wtf.form_field(settings_form.show_popularity) }}
    </div>

    <div class="well">
        <p>Workload model</p>

        <div class="row vertical-align">
            <div class="col-xs-6">
                <strong>Guideline CATS for supervision:</strong>
                {% if data.CATS_supervision is none or data.CATS_supervision == 0 %}
                    <span class="label label-default">Default</span>
                {% else %}
                    <span class="label label-info">{{ data.CATS_supervision }} CATS</span>
                {% endif %}
            </div>
            <div class="col-xs-6">
            <strong>Guideline CATS for marking:</strong>
                {% if data.CATS_marking is none or data.CATS_marking == 0 %}
                    <span class="label label-default">Default</span>
                {% else %}
                    <span class="label label-info">{{ data.CATS_marking }} CATS</span>
                {% endif %}
            </div>
        </div>
    </div>

    {{ wtf.form_field(settings_form.submit, button_map={'submit': 'primary'}) }}

    </form>
{% endblock %}
