{% import "bootstrap/wtf.html" as wtf %}

{% extends "base_app.html" %}

{% block scripts %}
    {{ super() }}
    {# jQuery is already loaded by flask-bootstrap, so we only need the datatables files #}
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs/jszip-2.5.0/dt-1.10.16/b-1.5.1/b-colvis-1.5.1/b-html5-1.5.1/b-print-1.5.1/cr-1.4.1/r-2.2.1/datatables.min.css"/>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs/jszip-2.5.0/dt-1.10.16/b-1.5.1/b-colvis-1.5.1/b-html5-1.5.1/b-print-1.5.1/cr-1.4.1/r-2.2.1/datatables.min.js"></script>

    <script>
        $(document).ready(function () {
            $('[class~="sortable-pageable"]').DataTable({
                responsive: true, bAutoWidth: false, colReorder: true, dom: 'lftBip',
                buttons: ['copy', 'csv', 'excel', 'pdf', 'print'], stateSave: true
            });
        });
    </script>
{% endblock %}

{% block title %}
    {{ pclass.name }}
{% endblock %}

{% macro truncate(name) %}
    {% if name|length > 20 %}
        {{ name[0:20] }}...
    {% else %}
        {{ name }}
    {% endif %}
{% endmacro %}

{% macro closed_panel(config) %}
    {% if config.live and config.closed %}
        <div class="panel panel-warning">
            <div class="panel-heading"><strong>Student choices are now closed</strong></div>
            <div class="panel-body">
                <div class="row vertical-align">
                    <div class="col-xs-9">
                        {% set valid, total = config.count_valid_students %}
                        <p><strong>{{ valid }}</strong> out of <strong>{{ total }}</strong>
                            students have valid selections (<strong>{{ total-valid }}</strong> remaining).</p>
                    </div>
                    <div class="col-xs-3">
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
{% endmacro %}

{% block pillblock %}
    <ul class="nav nav-pills dashboard-nav">
        <li {% if tabid==1 %}class="active"{% endif %}><a data-toggle="pill" href="#settings">
            Overview
        </a></li>
        <li {% if tabid==2 %}class="active"{% endif %}><a data-toggle="pill" href="#projects">
            Attached projects
            {% if projects %}
                {% set projects_count = projects.count() %}
                <span class="badge">{{ projects_count }}</span>
            {% endif %}
        </a></li>
        <li {% if tabid==3 %}class="active"{% endif %}><a data-toggle="pill" href="#faculty">
            Faculty enrollment
            {% if fac_count and faculty and faculty.count() > 0%}
                <span class="badge">{{ fac_count }}/{{ faculty.count() }}</span>
            {% else %}
                <span class="badge">0</span>
            {% endif %}
        </a></li>
        <li {% if tabid==4 %}class="active"{% endif %}><a data-toggle="pill" href="#selecting">
            Students selecting for {{ config.year+1 }}&ndash;{{ config.year+2 }}
            {% if selectors %}
                {% set selectors_count = selectors.count() %}
                <span class="badge">{{ selectors_count }}</span>
            {% endif %}
        </a></li>
        <li {% if tabid==5 %}class="active"{% endif %}><a data-toggle="pill" href="#joined">
            Students submitting in {{ config.year }}&ndash;{{ config.year+1 }}
            {% if submitters %}
                {% set submitters_count = submitters.count() %}
                <span class="badge">{{ submitters_count }}</span>
            {% endif %}
        </a></li>
        {% if config.live_projects %}
            {% set number_live_projects = config.live_projects.count() %}
            {% if number_live_projects > 0 %}
                <li {% if tabid==6 %}class="active"{% endif %}><a data-toggle="pill" href="#live">
                    Live projects for {{ config.year+1 }}&ndash;{{ config.year+2 }}
                    <span class="badge">{{ number_live_projects }}</span>
                </a></li>
            {% endif %}
        {% endif %}
    </ul>
{% endblock %}


{% macro userlist(users, title) %}


{% endmacro %}


{% block bodyblock %}
    <hr class="intro-divider">
    <div class="tab-content">



        <div id="settings" class="tab-pane fade {% if tabid==1 %}in active{% endif %}">
            <div class="row">
                <div class="col-xs-1"></div>
                <div class="col-xs-10">
                    <div class="dashboard-project-title">{{ pclass.name }} {{ config.year }}&ndash;{{ config.year+1 }}</div>
                    <hr class="intro-divider">

                    {# offer rollover of academic year if available #}
                    {% if config.year < current_year %}
                        <div class="panel panel-danger">
                            <div class="panel-heading"><strong>Rollover of academic year available</strong></div>
                            <div class="panel-body">
                                <div class="row vertical-align">
                                    <div class="col-xs-9">
                                        Rollover of the academic year to {{ current_year }} is now available.
                                    </div>
                                    <div class="col-xs-3">
                                        <div class="pull-right">
                                            <a href="{{ url_for('convenor.rollover', pid=pclass.id, configid=config.id) }}" class="btn btn-danger">Rollover</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    {# provide summary #}
                    <div class="panel panel-primary">
                        <div class="panel-heading">Status</div>
                        <div class="panel-body">
                            {% if config.project_class.require_confirm and not config.requests_issued %}

                                <div class="panel panel-danger">
                                    <div class="panel-heading"><strong>Confirmation of project descriptions</strong></div>
                                    <div class="panel-body">
                                        <form action="{{ url_for('convenor.issue_confirm_requests', id=pclass.id) }}" method="POST" name="issue-form">
                                            <div class="row vertical-top">
                                                <div class="col-xs-9">
                                                    Confirmation requests have not yet been issued to faculty
                                                </div>
                                                <div class="col-xs-3">
                                                    <div class="pull-right">
                                                        {{ wtf.form_field(issue_form.request_deadline) }}
                                                        {{ wtf.form_field(issue_form.requests_issued, button_map={'requests_issued': 'warning'}) }}
                                                    </div>
                                            </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>

                            {% else %}

                                {% if config.live and config.closed %}
                                    {{ closed_panel(config) }}
                                {% elif config.open %}
                                    <div class="panel panel-success">
                                        <div class="panel-heading"><strong>Student choices are currently live</strong></div>
                                        <div class="panel-body">
                                            <div class="row vertical-align">
                                                <div class="col-xs-9">
                                                    {% set valid, total = config.count_valid_students %}
                                                    <p><strong>{{ valid }}</strong> out of <strong>{{ total }}</strong>
                                                        students have valid selections (<strong>{{ total-valid }}</strong> remaining).</p>
                                                    <p>Finalize student selections</p>
                                                </div>
                                                <div class="col-xs-3">
                                                    <div class="pull-right">
                                                        <a href="{{ url_for('convenor.close_selections', id=config.id) }}" class="btn btn-success">
                                                            Close
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% elif not config.live %}
                                    {% if config.project_class.require_confirm %}

                                        {# if we get here then we can assume requests have been issued because of the outermost if#}
                                        <div class="panel panel-default">
                                            <div class="panel-heading"><strong>Student choices are not yet live</strong></div>
                                            <div class="panel-body">

                                                {% if config.golive_required.count() == 0 %}
                                                    <form action="{{ url_for('convenor.go_live', id=pclass.id) }}" method="POST" name="golive-form">
                                                        <div class="row vertical-top">
                                                            <div class="col-xs-9">
                                                                <p>All faculty confirmations have now been received.</p>
                                                                {% if projects %}
                                                                    <p>
                                                                        <strong>{{ projects.count() }}</strong> projects are currently
                                                                        available to go live.
                                                                        <strong>{{ fac_nooffer }} out of {{ fac_count }}</strong> eligible faculty
                                                                        do not yet have available projects.
                                                                    </p>
                                                                {% endif %}
                                                            </div>
                                                            <div class="col-xs-3">
                                                                <div class="pull-right">
                                                                    {{ wtf.form_field(golive_form.live_deadline) }}
                                                                    {{ wtf.form_field(golive_form.live, button_map={'live': 'primary'}) }}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </form>
                                                {% else %}
                                                    <div class="row vertical-top">
                                                        <div class="col-xs-9">
                                                            Confirmations are still outstanding from <strong>{{ config.golive_required.count() }} faculty</strong>.
                                                        </div>
                                                        <div class="col-xs-3">
                                                            <div class="pull-right">
                                                                <a href="{{ url_for('convenor.force_confirm_all', id=pclass.id) }}" class="btn btn-danger">
                                                                    Force confirm all
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <form action="{{ url_for('convenor.issue_confirm_requests', id=pclass.id) }}" method="POST" name="issue-form">
                                                        <div class="row vertical-align">
                                                            <div class="col-xs-9">
                                                                {{ wtf.form_field(issue_form.request_deadline) }}
                                                            </div>
                                                            <div class="col-xs-3">
                                                                <div class="pull-right">
                                                                    {{ wtf.form_field(issue_form.requests_issued, button_map={'requests_issued': 'primary'}) }}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </form>
                                                {% endif %}

                                            </div>
                                        </div>

                                        {# display list of faculty with outstanding confirm requests #}
                                        {% if config.golive_required.count() != 0 %}
                                            <table class="table table-striped table-bordered sortable-pageable">
                                                <thead>
                                                <tr>
                                                    <th width="50%"> Name</th>
                                                    <th width="20%"> Email</th>
                                                    <th width="10%"> Project available</th>
                                                    <th width="10%"> Projects not offerable</th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                    {% for faculty in config.golive_required %}
                                                        <tr>
                                                            {# name #}
                                                            <td> {{ faculty.user.build_name() }} </td>

                                                            {# email #}
                                                            <td>
                                                                <a href="mailto:{{ faculty.user.email }}">{{ faculty.user.email }}
                                                                </a>
                                                            </td>

                                                            {# projects available #}
                                                            <td>{{ faculty.projects_offered(pclass) }}</td>

                                                            {# projects unofferable #}
                                                            <td>{{ faculty.projects_unofferable() }}</td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        {% endif %}

                                    {% else %} {# confirmation not required anyway #}

                                        <div class="panel panel-danger">
                                            <div class="panel-heading"><strong>Student choices are not yet live</strong></div>
                                            <div class="panel-body">
                                                <form action="{{ url_for('convenor.go_live', id=pclass.id) }}" method="POST" name="golive-form">
                                                    <div class="row vertical-align">
                                                        <div class="col-xs-9">
                                                            Freeze project descriptions and open student choices.
                                                       </div>
                                                    <div class="col-xs-3">
                                                        <div class="pull-right">
                                                            {{ wtf.form_field(golive_form.live_deadline) }}
                                                            {{ wtf.form_field(golive_form.live, button_map={'live': 'success'}) }}
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>

                                    {% endif %}

                                {% endif %}

                            {% endif %}
                        </div>
                    </div>

                </div>
                <div class="col-xs-1"></div>
            </div>
        </div>



        <div id="projects" class="tab-pane fade {% if tabid==2 %}in active{% endif %}">
            {{ closed_panel(config) }}
            {% if projects and projects.count() > 0 %}
                <div class="panel panel-primary">
                    <div class="panel-heading">Projects attached to <strong>{{ pclass.name }}</strong></div>
                    <div class="panel-body">
                    <table class="table table-striped table-bordered sortable-pageable">
                        <thead>
                        <tr>
                            <th width="20%"> Name</th>
                            <th width="9%"> Owner</th>
                            <th width="9%"> Status</th>
                            <th width="10%"> Available for</th>
                            <th width="12%"> Affiliation</th>
                            <th width="20%"> Transferable skills</th>
                            <th width="20%"> Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for project in projects %}
                            <tr>
                                {# name #}
                                <td>
                                    {% set offerable = project.offerable %}
                                    <div class="{% if not offerable %}has-error{% endif %}">
                                        <a href="{{ url_for('faculty.project_preview', id=project.id) }}">
                                            <strong>{{ project.name }}</strong>
                                        </a>
                                        {% if not offerable and project.error %}
                                            <p class="help-block">Warning: {{ project.error }}</p>
                                        {% endif %}
                                    </div>
                                </td>

                                {# owner #}
                                <td>
                                    <a href="mailto:{{ project.owner.email }}">{{ project.owner.build_name() }}</a>
                                </td>

                                {# status #}
                                <td>
                                    {% if offerable %}
                                        {% if project.active %}
                                            Active
                                        {% else %}
                                            Inactive
                                        {% endif %}
                                    {% else %}
                                        <strong>Not available</strong>
                                    {% endif %}
                                </td>

                                {# project classes #}
                                <td>
                                    {% for pclass in project.project_classes %}
                                        <a class="btn btn-info btn-block btn-sm {% if loop.index > 1 %}btn-table-block{% endif %}" href="mailto:{{ pclass.convenor.email }}">
                                            {{ pclass.abbreviation }} ({{ pclass.convenor.build_name()  }})
                                        </a>
                                    {% endfor %}
                                </td>

                                {# affiliation #}
                                <td> <span class="label label-success">{{ project.group.abbreviation }}</span> </td>

                                {# transferable skills #}
                                <td>
                                    {% for skill in project.skills %}
                                        {% if skill.active %}
                                            <span class="label label-default">{{ skill.name }}</span>
                                        {% endif %}
                                    {% endfor %}
                                </td>

                                {# actions #}
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-success btn-sm btn-block dropdown-toggle" type="button" data-toggle="dropdown">
                                            Actions
                                            <span class="caret"></span>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <a href="{{ url_for('convenor.edit_project', id=project.id, pclass_id=pclass.id) }}">
                                                    <i class="fa fa-pencil"></i> Edit project
                                                </a>
                                            </li>
                                            <li>
                                                <a href="{{ url_for('faculty.project_preview', id=project.id) }}">
                                                    Preview web page
                                                </a>
                                            </li>

                                            <li>
                                                <a href="{{ url_for('convenor.attach_skills', id=project.id, pclass_id=pclass.id) }}">
                                                    <i class="fa fa-pencil"></i> Transferable skills
                                                </a>
                                            </li>

                                            <li>
                                                <a href="{{ url_for('convenor.attach_programmes', id=project.id, pclass_id=pclass.id) }}">
                                                    <i class="fa fa-pencil"></i> Degree programmes
                                                </a>
                                            </li>

                                            <li>
                                            {% if project.active %}
                                                <a href="{{ url_for('convenor.make_project_inactive', id=project.id, pclassid=pclass.id) }}">
                                                    Make inactive
                                                </a>
                                            {% else %}
                                                <a href="{{ url_for('convenor.make_project_active', id=project.id, pclassid=pclass.id) }}">
                                                    Make active
                                                </a>
                                            {% endif %}
                                            </li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    </div>
                </div>
                <div style="text-align: center;">
            {% else %}
                <div style="text-align: center;">
                <h3> No projects currently attached to <span class="label label-default">{{ pclass.name }}</span></h3>
                <hr class="intro-divider">
            {% endif %}
            <a href="{{ url_for('convenor.add_project', pclass_id=pclass.id) }}" class="btn btn-default btn-lg">
                <i class="fa fa-plus"></i>
                Add new project
            </a>
            </div>
        </div>



        <div id="faculty" class="tab-pane fade {% if tabid==3 %}in active{% endif %}">

            {{ closed_panel(config) }}
            {% if faculty and faculty.count() > 0 %}
                <div class="panel panel-primary">
                    <div class="panel-heading">Faculty enrolled in <strong>{{ pclass.name }}</strong></div>
                    <div class="panel-body">
                    <table class="table table-striped table-bordered sortable-pageable">
                        <thead>
                        <tr>
                            <th width="8%"> Last name</th>
                            <th width="8%"> First name</th>
                            <th width="14%"> Email</th>
                            <th width="10%"> Username</th>
                            <th width="10%"> Enrolled?</th>
                            <th width="10%"> Projects available</th>
                            <th width="10%"> Projects not offerable</th>
                            <th width="10%"> Go-live?</th>
                            <th width="20%"> Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for user, userdata in faculty %}
                            <tr>
                                {# last name #}
                                <td>{{ user.last_name }}</td>

                                {# first name #}
                                <td>{{ user.first_name }}</td>

                                {# email #}
                                <td>
                                    <a href="mailto:{{ user.email }}">{{ user.email }}</a>
                                </td>

                                {# username #}
                                <td>{{ user.username }}</td>

                                {# enrolled #}
                                <td>
                                    {% if pclass in userdata.enrollments %}
                                        Yes
                                    {% else %}
                                        No
                                    {% endif %}
                                </td>

                                {# number of projects offered #}
                                <td>
                                    {{ userdata.projects_offered(pclass) }}
                                </td>

                                {# number of unofferable projects #}
                                <td>
                                    {{ userdata.projects_unofferable() }}
                                </td>

                                {# go-live confirmation received? #}
                                <td>
                                    {% if config.project_class.require_confirm %}
                                        {% if config.requests_issued %}
                                            {% if current_user.faculty_data in config.golive_required %}
                                                <span class="label label-warning">Outstanding</span>
                                            {% else %}
                                                <span class="label label-success">Confirmed</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="label label-danger">Not yet issued</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="label label-default">Disabled</span>
                                    {% endif %}
                                </td>

                                {# actions #}
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-success btn-sm btn-block dropdown-toggle" type="button" data-toggle="dropdown">
                                            Actions
                                            <span class="caret"></span>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li>
                                            {% if pclass in userdata.enrollments %}
                                                <a href="{{ url_for('convenor.unenroll', userid=user.id, pclassid=pclass.id) }}">
                                                    Remove enrollment
                                                </a>
                                            {% else %}
                                                <a href="{{ url_for('convenor.enroll', userid=user.id, pclassid=pclass.id) }}">
                                                    Enroll
                                                </a>
                                            {% endif %}
                                            </li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    </div>
                </div>
            {% else %}
                <div style="text-align: center;">
                <h3> No faculty data
                <hr class="intro-divider">
                </div>
            {% endif %}
        </div>



        <div id="selecting" class="tab-pane fade {% if tabid==4 %}in active{% endif %}">

            {{ closed_panel(config) }}
            {% if selectors and selectors.count() > 0 %}
                <div class="panel panel-primary">
                    <div class="panel-heading">{{ title }}</div>
                    <div class="panel-body">
                        <table class="table table-striped table-bordered sortable-pageable">
                            <thead>
                                <tr>
                                    <th width="10%"> Last name </th>
                                    <th width="8%"> First name </th>
                                    <th width="12%"> Programme </th>
                                    <th width="15%"> Bookmarks </th>
                                    <th width="17%"> Pending </th>
                                    <th width="18%"> Confirmed </th>
                                    <th width="5%"> OK?</th>
                                    <th width="15%"> Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in selectors %}
                                    <tr>
                                        {# last name #}
                                        <td>{{ student.user.last_name }}</td>

                                        {# first name #}
                                        <td>{{ student.user.first_name }}</td>

                                        {# programme and cohort #}
                                        <td>
                                            <span class="label label-default">{{ student.user.student_data.programme.name }}</span>
                                            <span class="label label-info">Y{{ student.get_academic_year }}</span>
                                            <span class="label label-success">Cohort {{ student.user.student_data.cohort }}</span>
                                         </td>

                                        {# bookmarks #}
                                        <td>
                                            {% for bookmark in student.bookmarks %}
                                            {% set project = bookmark.liveproject %}
                                                <a href="{{ url_for('faculty.view_live_project', pid=project.id, classid=pclass.id, tabid=4) }}" class="btn btn-info btn-sm table-button">
                                                    {{ truncate(project.name) }}
                                                </a>
                                            {% else %}
                                                <span class="label label-default">None</span>
                                            {% endfor %}
                                        </td>

                                        {# confirm pending #}
                                        <td>
                                            {% for project in student.confirm_requests %}
                                                <div class="dropdown">
                                                    <button class="btn btn-success btn-sm dropdown-toggle table-button" type="button" data-toggle="dropdown">
                                                        <i class="fa fa-plus"></i> {{ truncate(project.name) }}
                                                    </button>
                                                    <ul class="dropdown-menu">
                                                        {% if config.open %}
                                                            <li>
                                                                <a href="{{ url_for('convenor.confirm', sid=student.id, pid=project.id, tabid=4) }}">
                                                                    Confirm
                                                                </a>
                                                            </li>
                                                            <li>
                                                                <a href="{{ url_for('convenor.cancel_confirm', sid=student.id, pid=project.id, tabid=4) }}">
                                                                    Remove
                                                                </a>
                                                            </li>
                                                        {% else %}
                                                            <li class="disabled">
                                                                <a>Confirm</a>
                                                            </li>
                                                            <li class="disabled">
                                                                <a>Remove</a>
                                                            </li>
                                                        {% endif %}
                                                    </ul>
                                                </div>
                                            {% else %}
                                                <span class="label label-default">None</span>
                                            {% endfor %}
                                        </td>

                                        {# confirmation granted #}
                                        <td>
                                            {% for liveproject in student.confirmed %}
                                                <div class="dropdown">
                                                    <button class="btn btn-warning btn-sm dropdown-toggle table-button" type="button" data-toggle="dropdown">
                                                        <i class="fa fa-plus"></i> {{ truncate(liveproject.name) }}
                                                    </button>
                                                    <ul class="dropdown-menu">
                                                        {% if config.open %}
                                                            <li>
                                                                <a href="{{ url_for('convenor.deconfirm', sid=student.id, pid=liveproject.id, tabid=4) }}">
                                                                    Remove
                                                                </a>
                                                            </li>
                                                            <li>
                                                                <a href="{{ url_for('convenor.deconfirm_to_pending', sid=student.id, pid=liveproject.id, tabid=4) }}">
                                                                    Make pending
                                                                </a>
                                                            </li>
                                                        {% else %}
                                                            <li class="disabled">
                                                                <a>Remove</a>
                                                            </li>
                                                            <li class="disabled">
                                                                <a>Make pending</a>
                                                            </li>
                                                        {% endif %}
                                                    </ul>
                                                </div>
                                            {% else %}
                                                <span class="label label-default">None</span>
                                            {% endfor %}
                                        </td>

                                        {# student's selection is OK? #}
                                        <td>
                                            {% if student.is_valid_selection %}
                                                <span class="label label-success">OK</span>
                                            {% else %}
                                                <span class="label label-danger">No</span>
                                            {% endif %}
                                        </td>

                                        {# actions #}
                                        <td>
                                            <div class="dropdown">
                                                <button class="btn btn-success btn-sm btn-block dropdown-toggle" type="button" data-toggle="dropdown">
                                                    Actions
                                                    <span class="caret"></span>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    {% if config.open and student.bookmarks and student.bookmarks.count() > 0 %}
                                                        <li>
                                                            <a href="{{ url_for('convenor.student_clear_bookmarks', sid=student.id) }}">
                                                                Clear bookmarks
                                                            </a>
                                                        </li>
                                                    {% else %}
                                                        <li class="disabled">
                                                            <a>Clear bookmarks</a>
                                                        </li>
                                                    {% endif %}

                                                    {% if config.open and student.confirm_requests and student.confirm_requests.count() > 0 %}
                                                        <li>
                                                            <a href="{{ url_for('convenor.student_confirm_all', sid=student.id) }}">
                                                                Confirm all requests
                                                            </a>
                                                        </li>
                                                        <li>
                                                            <a href="{{ url_for('convenor.student_clear_requests', sid=student.id) }}">
                                                                Clear all requests
                                                            </a>
                                                        </li>
                                                    {% else %}
                                                        <li class="disabled">
                                                            <a>Confirm all requests</a>
                                                        </li>
                                                        <li class="disabled">
                                                            <a>Clear all requests</a>
                                                        </li>
                                                    {% endif %}

                                                    {% if config.open and student.confirmed and student.confirmed.count() > 0 %}
                                                        <li>
                                                            <a href="{{ url_for('convenor.student_remove_confirms', sid=student.id) }}">
                                                                Remove confirmations
                                                            </a>
                                                            <a href="{{ url_for('convenor.student_make_all_confirms_pending', sid=student.id) }}">
                                                                Make all pending
                                                            </a>
                                                        </li>
                                                    {% else %}
                                                        <li class="disabled">
                                                            <a>Remove confirmations</a>
                                                        </li>
                                                        <li class="disabled">
                                                            <a>Make all pending</a>
                                                        </li>
                                                    {% endif %}
                                                </ul>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                </div>

            {% else %}

                <div style="text-align: center;">
                    <h3> No students are currently enrolled as selectors for
                        <span class="label label-default">{{ pclass.name }} {{ config.year }}&ndash;{{ config.year+1 }}</h3>
                </div>
                <hr class="intro-divider">

            {% endif %}

        </div>



        <div id="joined" class="tab-pane fade {% if tabid==5 %}in active{% endif %}">

            {{ closed_panel(config) }}
            {% if submitters and submitters.count() > 0 %}
                <div class="panel panel-primary">
                    <div class="panel-heading">{{ title }}</div>
                    <div class="panel-body">
                        <table class="table table-striped table-bordered sortable-pageable">
                            <thead>
                                <tr>
                                    <th width="30%"> Last name </th>
                                    <th width="30%"> First name </th>
                                    <th width="40%"> Programme </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in submitters %}
                                    <tr>
                                        {# last name #}
                                        <td>{{ student.user.last_name }}</td>

                                        {# first name #}
                                        <td>{{ student.user.first_name }}</td>

                                        {# programme and cohort #}
                                        <td>
                                            <span class="label label-default">{{ student.user.student_data.programme.name }}</span>
                                            <span class="label label-info">Y{{ student.get_academic_year }}</span>
                                            <span class="label label-success">Cohort {{ student.user.student_data.cohort }}</span>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                </div>

            {% else %}

                <div style="text-align: center;">
                    <h3> No students are currently enrolled for submitting work for
                        <span class="label label-default">{{ pclass.name }} {{ config.year }}&ndash;{{ config.year+1 }} </h3>
                </div>
                <hr class="intro-divider">

            {% endif %}

        </div>

        {% set number_live_projects = config.live_projects.count() %}
        {% if number_live_projects > 0 %}
            <div id="live" class="tab-pane fade {% if tabid==6 %}in active{% endif %}">

                {{ closed_panel(config) }}
                <div class="panel panel-primary">
                    <div class="panel-heading">Live projects for selection: <strong>{{ pclass.name }} {{ config.year+1 }}&ndash;{{ config.year+2 }}</strong></div>
                    <div class="panel-body">
                    <table class="table table-striped table-bordered sortable-pageable">
                        <thead>
                        <tr>
                            <th width="2%"> No.</th>
                            <th width="20%"> Name</th>
                            <th width="12%"> Owner</th>
                            <th width="10%"> Affiliation</th>
                            <th width="12%"> Bookmarks</th>
                            <th width="12%"> Pending</th>
                            <th width="12%"> Confirmed</th>
                            <th width="10%"> Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for project in config.live_projects %}
                            <tr>
                                {# number #}
                                <td><strong>{{ project.number }}</strong></td>

                                {# name #}
                                <td><strong>
                                    <a href="{{ url_for('faculty.view_live_project', pid=project.id, classid=pclass.id, tabid=6) }}">
                                        {{ project.name }}
                                    </a>
                                </strong></td>

                                {# owner #}
                                <td><a href="mailto:{{ project.owner.email }}">{{ project.owner.build_name() }}</a></td>

                                {# affiliation #}
                                <td> <span class="label label-success">{{ project.group.abbreviation }}</span> </td>

                                {# bookmarks #}
                                <td>
                                    {% for bookmark in project.bookmarks %}
                                        {% set student = bookmark.user %}
                                        <span class="label label-default">{{ student.user.build_name() }}</span>
                                    {% endfor %}
                                </td>

                                {# confirm pending #}
                                <td>
                                    {% for student in project.confirm_waiting %}
                                        <div class="dropdown">
                                            <button class="btn btn-success btn-sm dropdown-toggle" type="button" data-toggle="dropdown">
                                                <i class="fa fa-plus"></i> {{ student.user.build_name() }}
                                            </button>
                                            <ul class="dropdown-menu">
                                                {% if config.open %}
                                                    <li>
                                                        <a href="{{ url_for('convenor.confirm', sid=student.id, pid=project.id, tabid=6) }}">
                                                            Confirm
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a href="{{ url_for('convenor.cancel_confirm', sid=student.id, pid=project.id, tabid=6) }}">
                                                            Remove
                                                        </a>
                                                    </li>
                                                {% else %}
                                                    <li class="disabled">
                                                        <a>Confirm</a>
                                                    </li>
                                                    <li class="disabled">
                                                        <a>Remove</a>
                                                    </li>
                                                {% endif %}
                                            </ul>
                                        </div>
                                    {% else %}
                                        <span class="label label-default">None</span>
                                    {% endfor %}
                                </td>

                                {# confirmation granted #}
                                <td>
                                    {% for student in project.confirmed_students %}
                                        <div class="dropdown">
                                            <button class="btn btn-warning btn-sm dropdown-toggle table-button" type="button" data-toggle="dropdown">
                                                <i class="fa fa-plus"></i> {{ student.user.build_name() }}
                                            </button>
                                            <ul class="dropdown-menu">
                                                {% if config.open %}
                                                    <li>
                                                        <a href="{{ url_for('convenor.deconfirm', sid=student.id, pid=project.id, tabid=6) }}">
                                                            Remove
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a href="{{ url_for('convenor.deconfirm_to_pending', sid=student.id, pid=project.id, tabid=6) }}">
                                                            Make pending
                                                        </a>
                                                    </li>
                                                {% else %}
                                                    <li class="disabled">
                                                        <a>Remove</a>
                                                    </li>
                                                    <li class="disabled">
                                                        <a>Make pending</a>
                                                    </li>
                                                {% endif %}
                                            </ul>
                                        </div>
                                    {% else %}
                                        <span class="label label-default">None</span>
                                    {% endfor %}
                                </td>

                                {# actions #}
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-success btn-sm btn-block dropdown-toggle table-button" type="button" data-toggle="dropdown">
                                            Actions
                                            <span class="caret"></span>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <a href="{{ url_for('faculty.view_live_project', pid=project.id, classid=pclass.id, tabid=6) }}">
                                                    Preview web page
                                                </a>
                                            </li>
                                            {% if config.open and project.confirm_waiting and project.confirm_waiting.count() > 0 %}
                                                <li>
                                                    <a href="{{ url_for('convenor.project_confirm_all', pid=project.id) }}">
                                                        Confirm all requests
                                                    </a>
                                                    <a href="{{ url_for('convenor.project_clear_requests', pid=project.id) }}">
                                                        Clear all requests
                                                    </a>
                                                </li>
                                            {% else %}
                                                <li class="disabled">
                                                    <a>Confirm all requests</a>
                                                </li>
                                                <li class="disabled">
                                                    <a>Clear all requests</a>
                                                </li>
                                            {% endif %}

                                            {% if config.open and project.confirmed_students and project.confirmed_students.count() > 0 %}
                                                <li>
                                                    <a href="{{ url_for('convenor.project_remove_confirms', pid=project.id) }}">
                                                        Remove confirmations
                                                    </a>
                                                    <a href="{{ url_for('convenor.project_make_all_confirms_pending', pid=project.id) }}">
                                                        Make all pending
                                                    </a>
                                                </li>
                                            {% else %}
                                                <li class="disabled">
                                                    <a>Remove confirmations</a>
                                                </li>
                                                <li class="disabled">
                                                    <a>Make all pending</a>
                                                </li>
                                            {% endif %}
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    </div>
                </div>

            </div>
        {% endif %}



    </div>
{% endblock %}
