{% from "icon_block.html" import icon_block %}

{% macro prelive_capacity(data, sel_count) %}
    {% set groups = data['data'] %}
    {% set total_projects = data['projects'] %}
    {% set total_faculty = data['faculty_offering'] %}
    {% set total_capacity = data['capacity'] %}
    {% set total_capacity_bounded = data['capacity_bounded'] %}
    <div class="row vertical-align capacity-table">
        <div class="col-4"><strong>Research group</strong></div>
        <div class="col-2"><strong>Projects offered</strong></div>
        <div class="col-2"><strong>Student capacity</strong></div>
        <div class="col-2"><strong>Faculty offering projects</strong></div>
        <div class="col-2"><strong>Enrollment</strong></div>
    </div>
    <hr class="intro-divider">
    {% for group in groups %}
        {% set label = group['label'] %}
        {% set group_data = group['data'] %}
        {% set proj_count = group_data['projects'] %}
        {% set fac_count = group_data['faculty_offering'] %}
        {% set enrolled = group_data['faculty_enrolled'] %}
        {% set total = group_data['faculty_in_group'] %}
        {% set capacity = group_data['capacity'] %}
        {% set bounded = group_data['bounded'] %}
        <div class="row vertical-align capacity-table">
            <div class="col-4">{{ label|safe }}</div>
            <div class="col-2">
                {% if proj_count > 0 %}
                    {{ proj_count }}
                {% else %}
                    <span class="badge badge-danger">None</span>
                {% endif %}
            </div>
            <div class="col-2">
                {% if capacity > 0 %}
                    {% if not bounded %}>= {% endif %}{{ capacity }}
                {% else %}
                    <span class="badge badge-danger">None</span>
                {% endif %}
            </div>
            <div class="col-2">
                {% if fac_count > 0 %}
                    {{ fac_count }}
                {% else %}
                    <span class="badge badge-danger">None</span>
                {% endif %}
            </div>
            <div class="col-2">
                {{ enrolled }}/{{ total }}
            </div>
        </div>
    {% endfor %}
    <hr class="into-divider">
    <div class="row vertical-align capacity-table">
        <div class="col-4"><strong>Total</strong></div>
        <div class="col-2"><span class="badge badge-pill badge-info">{{ total_projects }}</span></div>
        <div class="col-2">{% if not total_capacity_bounded %}>= {% endif %}<span class="badge badge-pill badge-info">{{ total_capacity }}</span></div>
        <div class="col-2"></div>
        <div class="col-2"></div>
    </div>
    {% if total_capacity < sel_count %}
        <div class="alert alert-danger">
            <strong>Warning.</strong>
            There are fewer project places than selectors. More projects are required.
        </div>
    {% elif total_capacity < 1.15*sel_count %}
        <div class="alert alert-danger">
            <strong>Warning.</strong>
            Total capacity is no more than 15% above number of selectors.
            The project allocation is likely to be inflexible.
            Consider adding more projects.
        </div>
    {% endif %}
    {% if total_capacity >= sel_count %}
        {% if total_faculty >= sel_count %}
            <div class="alert alert-info">
                {% call icon_block("info-circle") %}
                    <div>Approximate allocation is less than one project per faculty member.</div>
                    <div class="mt-1"><strong>Warning.</strong> This estimate does not account for constraints.</div>
                {% endcall %}
            </div>
        {% else %}
            {% set alloc = sel_count / total_faculty %}
            {% set alloc_lo = alloc|round(1, 'floor') %}
            {% set alloc_hi = alloc|round(1, 'ceil') %}
            <div class="alert alert-info">
                Approximate allocation is between {{ alloc_lo }} and {{ alloc_hi }}
                projects per faculty member.
                <p>
                    <strong>Warning.</strong> This estimate does not account for constraints.
                </p>
            </div>
        {% endif %}
    {% endif %}
{% endmacro %}
