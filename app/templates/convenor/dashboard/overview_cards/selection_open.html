{% import "bootstrap/form.html" as wtf %}
{% from "macros.html" import date_field %}

{% macro selection_open(config, change_form) %}
    <div class="panel panel-success">
        <div class="panel-heading">
            <strong>Student selections are currently live</strong>
            {% if config.live_deadline %}
                &ndash;
                deadline {{ config.live_deadline.strftime("%a %d %b %Y") }}
            {% endif %}
        </div>
        <div class="panel-body">
            {% set selector_data = config.selector_data %}
            {% set submitted = selector_data['have_submitted'] %}
            {% set bookmarks = selector_data['have_bookmarks'] %}
            {% set missing = selector_data['missing'] %}
            {% set total = selector_data['total'] %}
            {% set outstanding_confirm = selector_data['outstanding_confirm'] %}
            <div class="row vertical-top">
                <div class="col-xs-4">
                    <div class="list-group">
                        <div class="list-group-item {% if submitted == total %}list-group-item-success{% else %}list-group-item-secondary"{% endif %}>
                            Submitted
                            <a href="{{ url_for('convenor.selectors', id=config.pclass_id, state_filter='submitted') }}">(Show...)</a>
                            <span class="badge">{{ submitted }}/{{ total }}</span>
                        </div>
                        <div class="list-group-item {% if outstanding_confirm > 0 %}list-group-item-danger{% else %}list-group-item-success{% endif %}">
                            Confirmation requests
                            <a href="{{ url_for('convenor.show_confirmations', id=config.pclass_id) }}">(Show...)</a>
                            <span class="badge">{{ outstanding_confirm }}</span>
                        </div>
                    </div>
                </div>
                <div class="col-xs-4">
                    <div class="list-group">
                        <div class="list-group-item {% if bookmarks > 0 %}list-group-item-primary{% else %}list-group-item-secondary{% endif %}">
                            Has bookmarks
                            <a href="{{ url_for('convenor.selectors', id=config.pclass_id, state_filter='bookmarks') }}">(Show...)</a>
                            <span class="badge">{{ bookmarks }}/{{ total }}</span>
                        </div>
                    </div>
                </div>
                <div class="col-xs-4">
                    <div class="list-group">
                        <div class="list-group-item {% if bookmarks > 0 %}list-group-item-primary{% else %}list-group-item-secondary{% endif %}">
                            No bookmarks
                            <a href="{{ url_for('convenor.selectors', id=config.pclass_id, state_filter='none') }}">(Show...)</a>
                            <span class="badge">{{ missing}}/{{ total }}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row vertical-top">
                <div class="col-xs-12">
                    {% if submitted == total %}
                        <p>All students have submitted validated choices.</p>
                        <p>
                            It is safe to close selections.
                            {% if total == 0 %}
                                <a class="btn btn-sm btn-danger" href="{{ url_for('convenor.reverse_golive', config_id=config.id) }}" style="margin-left: 10px;">
                                    Reverse Go Live to add more selectors
                                </a>
                            {% endif %}
                        </p>
                        <span class="label label-success"><i class="fa fa-check"></i> READY TO PROCEED</span>
                    {% elif missing == 0 %}
                        <p>
                            Some students have not yet submitted a validated selection, but all students
                            have bookmark data.
                        </p>
                        {% if config.selection_open_to_all %}
                            <p><strong>Selection for this project is available to all eligible students on an opt-in basis.</strong></p>
                            <p>
                                If selections are closed now, students who have not submitted a validated selection
                                will be assumed not to have opted-in and will be ignored when performing
                                automatic matching.
                            </p>
                        {% else %}
                            <p>
                                If selections are closed now, bookmark data will be used when performing
                                automatic matching for students who are missing a validated selection.
                            </p>
                        {% endif %}
                        <span class="label label-warning"><i class="fa fa-exclamation-triangle"></i> PROCEED WITH CAUTION</span>
                    {% else %}
                        <p>Some students are missing both a validated selection and bookmark data.</p>
                        {% if config.selection_open_to_all %}
                            <p><strong>Selection for this project is available to all eligible students on an opt-in basis.</strong></p>
                            <p>
                                If selections are closed now, students who have not submitted a validated selection
                                will be assumed not to have opted-in and will be ignored when performing
                                automatic matching.
                            </p>
                        {% else %}
                            <p>
                                If selections are closed now, these students will be allocated an arbitrary project
                                during automated matching.
                            </p>
                        {% endif %}
                        <span class="label label-warning"><i class="fa fa-exclamation-triangle"></i> PROCEED WITH CAUTION</span>
                    {% endif %}
                </div>
            </div>
            <hr class="intro-divider">
            <form action="{{ url_for('convenor.adjust_selection_deadline', configid=config.id) }}" method="POST" name="adjust_selection_deadline">
                {{ change_form.hidden_tag() }}
                {{ date_field(change_form.live_deadline) }}
                {{ wtf.form_field(change_form.notify_convenor) }}
                <div class="row vertical-top">
                    <div class="col-xs-12">
                        <div class="pull-right">
                            <a href="{{ url_for('convenor.reset_popularity_data', id=config.id) }}"
                               class="btn btn-default grouped-button-margin">
                                Reset popularity data
                            </a>
                            {{ wtf.form_field(change_form.change, button_map={'change': 'default'}) }}
                            {{ wtf.form_field(change_form.close, button_map={'close': 'primary'}) }}
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
{% endmacro %}
