{% import "bootstrap/form.html" as wtf %}
{% from "macros.html" import date_field %}
{% from "icon_block.html" import icon_block %}

{% macro dashboard_tile(title, title_icon=none, icon_state=none) %}
    <div class="card border-0 bg-light">
        <div class="card-body">
            <div class="row">
                <div class="col d-flex justify-content-between">
                    <div>
                        <div class="d-flex flex-row gap-2 justify-content-left align-items-center">
                            {% if title_icon is not none %}
                                {% if icon_state is true %}
                                    <i class="text-success fs-6 fas fa-{{ title_icon }} me-1 pb-2"></i>
                                {% elif icon_statei is false %}
                                    <i class="text-warning fs-6 fas fa-{{ title_icon }} me-1 pb-2"></i>
                                {% else %}
                                    <i class="text-secondary fs-6 fas fa-{{ title_icon }} me-1 pb-2"></i>
                                {% endif %}
                            {% endif %}
                            <span class="d-flex align-items-center text-uppercase text-muted fw-semibold fs-6 mb-2">
                                {{ title }}
                            </span>
                        </div>
                        {{ caller() }}
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endmacro %}

{% macro selection_open(config, change_form, data) %}
    <div class="card border-secondary mt-3 mb-3">
        <div class="card-header">
            <strong>Student selections are currently live</strong>
            {% if config.live_deadline %}
                &ndash;
                deadline {{ config.live_deadline.strftime("%a %d %b %Y") }}
            {% endif %}
        </div>
        <div class="card-body">
            {% set selector_data = config.selector_data %}
            {% set submitted = selector_data['have_submitted'] %}
            {% set bookmarks = selector_data['have_bookmarks'] %}
            {% set missing = selector_data['missing'] %}
            {% set total = selector_data['total'] %}
            {% set outstanding_confirm = data['outstanding_confirms_count'] %}
            <div class="mb-3">
                {% if submitted == total %}
                    <div class="alert alert-success mb-3">
                        {% call icon_block("info-circle") %}
                            <div><strong>All students have submitted validated choices.</strong></div>
                            <div>
                                It is safe to close selections.
                                {% if total == 0 %}
                                    <a class="btn btn-sm btn-outline-danger" href="{{ url_for('convenor.reverse_golive', config_id=config.id) }}" style="margin-left: 10px;">
                                        Reverse Go Live to add more selectors
                                    </a>
                                {% endif %}
                            </div>
                        {% endcall %}
                    </div>
                {% elif missing == 0 %}
                    <div class="alert alert-info mb-3">
                        {% call icon_block("info-circle") %}
                            <div><strong>Some students have not yet submitted a validated selection.</strong></div>
                            <div class="mt-1">
                                However, all students have bookmark data.
                            </div>
                        {% endcall %}
                    </div>
                    {% if config.selection_open_to_all %}
                        <div class="alert alert-warning mb-3">
                            {% call icon_block("exclamation-circle") %}
                                <div>
                                    <strong>Selection for this project is available to all eligible students on an opt-in basis.</strong>
                                </div>
                                <div class="mt-1">
                                    If selections are closed now, students who have not submitted a validated selection
                                    will be assumed not to have opted-in and will be ignored when performing
                                    automatic matching.
                                </div>
                            {% endcall %}
                        </div>
                    {% else %}
                        <div class="alert alert-info mb-3">
                            {% call icon_block("info-circle") %}
                                <div><strong>Bookmark data will be used for automated matching.</strong></div>
                                <div class="mt-1">
                                    If selections are closed now, bookmark data will be used when performing
                                    automated matching for students missing a validated selection.
                                </div>
                            {% endcall %}
                        </div>
                    {% endif %}
                {% else %}
                    <div class="alert alert-warning mb-3">
                        {% call icon_block("exclamation-circle") %}
                            <div><strong>Some students are missing both a validated selection and bookmark data.</strong></div>
                        {% endcall %}
                    </div>
                    {% if config.selection_open_to_all %}
                        <div class="alert alert-warning mb-3">
                            {% call icon_block("info-circle") %}
                                <div>
                                    <strong>Selection for this project is available to all eligible students on an opt-in basis.</strong>
                                </div>
                                <div class="mt-1">
                                    If selections are closed now, students who have not submitted a validated selection
                                    will be assumed not to have opted-in and will be ignored when performing
                                    automatic matching.
                                </div>
                            {% endcall %}
                        </div>
                    {% else %}
                        <div class="alert alert-info mb-3">
                            {% call icon_block("info-circle") %}
                                <div><strong>Bookmark data will be used for automated matching.</strong></div>
                                <div class="mt-1">
                                    If selections are closed now, bookmark data will be used when performing
                                    automated matching for students missing a validated selection.
                                </div>
                            {% endcall %}
                        </div>
                    {% endif %}
                {% endif %}
            </div>
            {% set submitted_ok = submitted == total %}
            {% set confirmations_ok = outstanding_confirm == 0 %}
            {% set bookmarks_ok = bookmarks > 0 %}
            {% set missing_ok = missing == 0 %}
            <div class="row">
                <div class="col-3">
                    {% call dashboard_tile("Submitted", title_icon="circle", icon_state=submitted_ok) %}
                        <span class="fw-bold fs-1 {% if submitted_ok %}text-primary{% else %}text-warning{% endif %}">{{ submitted }}</span>
                        <span class="fs-4 text-muted">/{{ total }}</span>
                        <p class="small mb-0">
                            <a class="text-decoration-none link-secondary"
                               href="{{ url_for('convenor.selectors', id=config.pclass_id, state_filter='submitted') }}">View
                                submiters</a>
                        </p>
                    {% endcall %}
                </div>
                <div class="col-3">
                    {% call dashboard_tile("Confirmations", title_icon="circle", icon_state=confirmations_ok) %}
                        <span class="fw-bold fs-1 {% if confirmations_ok %}text-primary{% else %}text-warning{% endif %}">{{ outstanding_confirm }}</span>
                        <p class="small mb-0">
                            <a class="text-decoration-none link-secondary"
                               href="{{ url_for('convenor.show_confirmations', id=config.pclass_id) }}">View
                                requests</a>
                        </p>
                    {% endcall %}
                </div>
                <div class="col-3">
                    {% call dashboard_tile("Bookmarks", title_icon="circle", icon_state=bookmarks_ok) %}
                        <span class="fw-bold fs-1 {% if bookmarks_ok %}text-primary{% else %}text-warning{% endif %}">{{ bookmarks }}</span>
                        <span class="fs-4 text-muted">/{{ total }}</span>
                        <p class="small mb-0">
                            <a class="text-decoration-none link-secondary"
                               href="{{ url_for('convenor.selectors', id=config.pclass_id, state_filter='bookmarks') }}">View
                                selectors</a>
                        </p>
                    {% endcall %}
                </div>
                <div class="col-3">
                    {% call dashboard_tile("No bookmarks", title_icon="circle", icon_state=missing_ok) %}
                        <span class="fw-bold fs-1 {% if missing_ok %}text-primary{% else %}text-warning{% endif %}">{{ missing }}</span>
                        <span class="fs-4 text-muted">/{{ total }}</span>
                        <p class="small mb-0">
                            <a class="text-decoration-none link-secondary"
                               href="{{ url_for('convenor.selectors', id=config.pclass_id, state_filter='none') }}">View
                                selectors</a>
                        </p>
                    {% endcall %}
                </div>
            </div>
            <form action="{{ url_for('convenor.adjust_selection_deadline', configid=config.id) }}" method="POST" name="adjust_selection_deadline">
                {{ change_form.hidden_tag() }}
                {{ date_field(change_form.live_deadline, 'live_datetimepicker') }}
                {{ wtf.render_field(change_form.notify_convenor) }}
                <div class="d-flex flex-row justify-content-end align-items-end gap-2">
                    <a href="{{ url_for('convenor.reset_popularity_data', id=config.id) }}"
                       class="btn btn-sm btn-outline-secondary">
                        Reset popularity data
                    </a>
                    {{ wtf.render_field(change_form.change, button_map={'change': 'outline-secondary'}, button_size='sm') }}
                    {{ wtf.render_field(change_form.close, button_map={'close': 'outline-primary'}, button_size='sm') }}
                </div>
            </form>
        </div>
    </div>
{% endmacro %}
