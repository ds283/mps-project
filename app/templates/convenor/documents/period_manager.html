{% extends "base_app.html" %}

{% import "bootstrap/wtf.html" as wtf %}

{% block title %}
    Manage documents for {{ record.display_name }}
{% endblock %}

{% macro asset_line(asset, attachment, download_url, delete_url, edit_url) %}
    <tr>
        <td>
            <div>
                {% if asset.target_name %}
                    <strong>{{ asset.target_name }}</strong>
                {% else %}
                    <strong>{{ asset.filename }}</strong>
                {% endif %}
            </div>
            {% if attachment and attachment.description and attachment.description|length > 0 %}
                <div style="padding-top: 3px;">
                    {{ attachment.description }}
                </div>
            {% endif %}
        </td>
        <td>
            <div>
                {% if asset.timestamp %}
                    uploaded at {{ asset.timestamp.strftime("%a %d %b %Y %H:%M:%S") }}
                {% endif %}
                {% if asset.uploaded_by %}
                    <i class="fa fa-user"></i> {{ asset.uploaded_by.name }}
                {% endif %}
            </div>
            <div>
                {% if attachment.publish_to_students %}
                    <span class="label label-success"><i class="fa fa-check"></i> Publish to students</span>
                {% endif %}
                {% if attachment.include_marking_emails %}
                    <span class="label label-success"><i class="fa fa-check"></i> Include in marking emails</span>
                {% endif %}
            </div>
        </td>
        <td>
            <div style="text-align: right;" class="pull-right">
                {% if asset.has_access(current_user.id) %}
                    <a href="{{ edit_url }}" class="btn btn-sm btn-default btn-table-block">Edit</a>
                    <a href="{{ download_url }}" class="btn btn-sm btn-default btn-table-block">Download</a>
                    <a href="{{ delete_url }}" class="btn btn-sm btn-danger btn-table-block">Remove</a>
                {% else %}
                    <a class="btn btn-default btn-sm disabled btn-table-block">Edit</a>
                    <a class="btn btn-default btn-sm disabled btn-table-block">Download</a>
                    <a class="btn btn-danger btn-sm disabled btn-table-block">Remove</a>
                {% endif %}
            </div>
        </td>
    </tr>
{% endmacro %}

{% block bodyblock %}
    {% if url and text %}
        <div class="top-return-link">
            <a href="{{ url }}">
                <i class="fa fa-backward"></i> Return to {{ text }}
            </a>
        </div>
    {% endif %}

    <div class="panel panel-primary panel-primary-bg">
        <div class="panel-heading">Manage documents for <strong>{{ record.display_name }}</strong></div>
        <div class="panel-body">
            <div class="well">
                {% if record.attachments.first() %}
                    <span class="document-group-title">Attachments</span>
                    <hr class="intro-divider">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th width="40%">Document</th>
                                <th width="30%">Attributes</th>
                                <th width="30%"></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for attachment in record.attachments %}
                                {% set asset = attachment.attachment %}
                                {{ asset_line(asset, attachment, url_for('admin.download_submitted_asset', asset_id=asset.id),
                                              url_for('convenor.delete_period_attachment', aid=attachment.id),
                                              url_for('convenor.edit_period_attachment', aid=attachment.id, url=url, text=text)) }}
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <strong>No attachments.</strong>
                {% endif %}
                <hr class="into-divider">
                <div style="text-align: center;">
                    <a href="{{ url_for('convenor.upload_period_attachment', pid=record.id, url=url, text=text) }}" class="btn btn-default btn-lg">
                        <i class="fa fa-plus"></i>
                        Upload new attachment
                    </a>
                </div>
            </div>
        </div>
    </div>

    {% if url and text %}
        <a href="{{ url }}">
            <i class="fa fa-backward"></i> Return to {{ text }}
        </a>
    {% endif %}
{% endblock %}
