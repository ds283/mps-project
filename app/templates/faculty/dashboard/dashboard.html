{% extends "base_app.html" %}

{% from "faculty/dashboard/pclass_card.html" import pclass_card with context %}
{% from "faculty/dashboard/availability_card.html" import availability_card %}
{% from "admin/admin_dashboard/admin_card.html" import admin_dashboard_card %}
{% from "admin/admin_dashboard/root_functions.html" import root_functions, root_messages %}
{% from "user_approver/dashboard_panel.html" import user_approver_panel %}
{% from "project_approver/dashboard_panel.html" import project_approver_panel %}
{% from "macros.html" import message_card %}

{% set is_root = current_user.has_role('root') %}
{% set is_admin = current_user.has_role('admin') %}
{% set is_user_approver = current_user.has_role('user_approver') %}
{% set is_project_approver = current_user.has_role('project_approver') %}

{% block pillblock %}
    <ul class="nav nav-pills dashboard-nav">
        {% if is_root %}
            {% set warning = root_dash_data['warning'] %}
            {% set messages = root_dash_data['messages'] %}
            <li {% if pane == 'system' %}class="active"{% endif %}>
                <a href="{{ url_for('faculty.dashboard', pane='system') }}">
                    {% if warning or (messages is not none and messages|length > 0) %}
                        <i class="fa fa-exclamation-triangle"></i>
                    {% endif %}
                    Administration
                </a>
            </li>
        {% endif %}
        {% set approve_total = approvals_data['total'] %}
        {% set user_num_rejected = approvals_data.get('approval_user_rejected') %}
        {% set project_num_rejected = approvals_data.get('approval_project_rejected') %}
        {% set user_warning = (user_num_rejected > 0) if user_num_rejected is not none else false %}
        {% set project_warning = (project_num_rejected > 0) if project_num_rejected is not none else false %}
        {% if is_user_approver or is_project_approver or (user_warning and (is_admin or is_root)) %}
            <li {% if pane == 'approve' %}class="active"{% endif %}>
                <a href="{{ url_for('faculty.dashboard', pane='approve') }}">
                    {% if user_warning or project_warning %}
                        <i class="fa fa-exclamation-triangle"></i>
                    {% endif %}
                    Approvals
                    {% if approve_total > 0 %}
                        <span class="badge badge-info">{{ approve_total }}</span>
                    {% endif %}
                </a>
            </li>
        {% endif %}
        {% if enrollments %}
            {% for item in enrollments %}
                {% set config = item['config'] %}
                <li {% if pane == config.id|string %}class="active"{% endif %}>
                    <a href="{{ url_for('faculty.dashboard', pane=config.id) }}">
                        {% set selector_state = config.selector_lifecycle %}
                        {% set submitter_state = config.submitter_lifecycle %}
                        {% set nproj = current_user.faculty_data.number_projects_offered(config.project_class) %}
                        {% if selector_state == config.SELECTOR_LIFECYCLE_WAITING_CONFIRMATIONS and current_user.faculty_data in config.confirmation_required
                           or submitter_state == config.SUBMITTER_LIFECYCLE_MARKING_ACTIVITY
                           or (nproj == 0 and config.uses_supervisor) %}
                            <i class="fa fa-exclamation-triangle"></i>
                        {% endif %}
                        {{ config.name }}
                    </a>
                </li>
            {% endfor %}
        {% endif %}
    </ul>
{% endblock %}

{% block title %}
    Faculty dashboard
{% endblock %}

{% block bodyblock %}
    <div class="row">
        <div class="col-xs-1"></div>
        <div class="col-xs-10">

            {% if messages %}
                {% for message in messages %}
                    {{ message_card(message, current_user.faculty_data) }}
                {% endfor %}
            {% endif %}

            {% if is_root and pane == 'system' %}
                {{ root_messages(root_dash_data) }}
            {% endif %}

            {% if current_user.faculty_data.has_outstanding_availability_requests %}
                {{ availability_card(current_user.faculty_data) }}
            {% endif %}

            {% if pane == 'approve' %}
                {% if is_user_approver or (approvals_data['approval_user_rejected'] > 0 and (is_admin or is_root)) %}
                    {{ user_approver_panel(approvals_data, current_user) }}
                {% endif %}
                {% if is_project_approver %}
                    {{ project_approver_panel(approvals_data) }}
                {% endif %}
            {% endif %}

            {% if is_root and pane == 'system' %}
                <div class="well">
                    {{ admin_dashboard_card(root_dash_data) }}
                    {{ root_functions(root_dash_data, has_assessments) }}
                </div>
            {% else %}
                {% if enrollments and enrollments|length > 0 %}

                    {% for item in enrollments %}
                        {% set config = item['config'] %}
                        {% if pane == config.id|string %}
                            {% set live_projects = item['projects'] %}
                            {% set record = item['record'] %}
                            {{ pclass_card(item, today) }}
                        {% endif %}
                    {% endfor %}

                {% else %}

                    <div class="well">
                        <h3 class="dashboard-subtitle"> You have no active project enrollments</h3>
                        <p>
                            Project classes for which you are enrolled, but are not active because of
                            sabbatical, buy-out or exemption, are not shown.
                        </p>
                        <p>
                            If you believe this to be an error, please contact the convenor for the
                            appropriate project class. The convenors and their contact details
                            can be obtained from your settings page.
                        </p>
                        <hr class="intro-divider">
                        <p>
                            <a href="{{ url_for('faculty.settings') }}">View my settings</a>
                        </p>
                    </div>

                {% endif %}
            {% endif %}

        </div>
        <div class="col-xs-1"></div>
    </div>
{% endblock %}
