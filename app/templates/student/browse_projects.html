{% import "bootstrap/wtf.html" as wtf %}

{% extends "base_app.html" %}

{% block scripts %}
    {{ super() }}
    {# jQuery is already loaded by flask-bootstrap, so we only need the datatables files #}
    <link rel="stylesheet" type="text/css"
          href="https://cdn.datatables.net/v/bs/jszip-2.5.0/dt-1.10.16/b-1.5.1/b-colvis-1.5.1/b-html5-1.5.1/b-print-1.5.1/cr-1.4.1/r-2.2.1/datatables.min.css"/>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/vfs_fonts.js"></script>
    <script type="text/javascript"
            src="https://cdn.datatables.net/v/bs/jszip-2.5.0/dt-1.10.16/b-1.5.1/b-colvis-1.5.1/b-html5-1.5.1/b-print-1.5.1/cr-1.4.1/r-2.2.1/datatables.min.js"></script>

    <script>
        $(document).ready(function () {
            $('[class~="sortable-pageable"]').DataTable({
                responsive: true, bAutoWidth: false, colReorder: true, dom: 'lftBip',
                buttons: ['copy', 'csv', 'excel', 'pdf', 'print'], stateSave: true
            });
        });
    </script>
{% endblock %}

{% block title %}
    Browse projects
{% endblock %}

{% block bodyblock %}
    {% if projects %}
        <div class="panel panel-primary">
            <div class="panel-heading">
                Projects available for
                <strong>{{ config.project_class.name }} {{ config.year+1 }}&ndash;{{ config.year+2 }}</strong>
            </div>
            <div class="panel-body">
                <table class="table table-striped table-bordered sortable-pageable">
                    <thead>
                    <tr>
                        <th width="5%"> Number</th>
                        <th width="20%"> Title</th>
                        <th width="15%"> Supervisor</th>
                        <th width="20%"> Research group</th>
                        <th width="20%"> Availability</th>
                        <th width="5%"> Bookmarked</th>
                        <th width="15%"> Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for project in projects %}
                        <tr>
                            {# number #}
                            <td>{{ project.number }}</td>

                            {# title #}
                            <td>
                                <a href="{{ url_for('student.view_project', sid=sel.id, pid=project.id) }}">{{ project.name }}</a>
                            </td>

                            {# supervisor #}
                            <td>{{ project.owner.build_name() }} <a
                                    href="mailto:{{ project.owner.email }}">{{ project.owner.email }}</a></td>

                            {# research group #}
                            <td><span class="label label-success">{{ project.group.abbreviation }}</span></td>

                            {# availability #}
                            <td>
                                {% if project.meeting_reqd == project.MEETING_REQUIRED %}
                                    <span class="label label-danger">Meeting required</span>
                                {% elif project.meeting_reqd == project.MEETING_OPTIONAL %}
                                    <span class="label label-warning">Meeting optional</span>
                                {% else %}
                                    <span class="label label-default">Meeting not required</span>
                                {% endif %}
                                {% if project.is_available(sel) %}
                                    <span class="label label-success">Available</span>
                                {% else %}
                                    {% if sel in project.confirm_waiting %}
                                        <a href="{{ url_for('student.cancel_confirmation', sid=sel.id, pid=project.id) }}" class="btn btn-warning btn-sm table-button">
                                            Cancel
                                        </a>
                                    {% else %}
                                        <a href="{{ url_for('student.request_confirmation', sid=sel.id, pid=project.id) }}" class="btn btn-success btn-sm table-button">
                                            Request
                                        </a>
                                    {% endif %}
                                {% endif %}
                            </td>

                            {# bookmarked #}
                            <td>
                                {% set bookmarked = false %}
                                {% if sel.bookmarks.filter_by(liveproject_id=project.id).count() > 0 %}
                                    {% set bookmarked = true %}
                                    <div class="row vertical-align">
                                        <div class="col-xs-4">
                                            Yes
                                        </div>
                                        <div class="col-xs-8">
                                            <div class="pull-right">
                                                <a href="{{ url_for('student.remove_bookmark', sid=sel.id, pid=project.id) }}" class="btn btn-default btn-sm">
                                                    Remove
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="row vertical-align">
                                        <div class="col-xs-5">
                                            No
                                        </div>
                                        <div class="col-xs-7">
                                            <div class="pull-right">
                                                <a href="{{ url_for('student.add_bookmark', sid=sel.id, pid=project.id) }}" class="btn btn-default btn-sm">
                                                    Add
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            </td>

                            {# actions #}
                            <td>
                                <div class="dropdown">
                                    <button class="btn btn-success btn-sm btn-block dropdown-toggle" type="button"
                                            data-toggle="dropdown">
                                        Actions
                                        <span class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <a href="{{ url_for('student.view_project', sid=sel.id, pid=project.id) }}">
                                                View project
                                            </a>
                                        </li>
                                        <li>
                                            {% if bookmarked %}
                                                <a href="{{ url_for('student.remove_bookmark', sid=sel.id, pid=project.id) }}">
                                                    Remove bookmark
                                                </a>
                                            {% else %}
                                                <a href="{{ url_for('student.add_bookmark', sid=sel.id, pid=project.id) }}">
                                                    Add bookmark
                                                </a>
                                            {% endif %}
                                        </li>
                                        <li {% if project.is_available(sel) %}class="disabled"{% endif %}>
                                            {% if not project.is_available(sel) %}
                                                {% if sel in project.confirm_waiting %}
                                                    <a href="{{ url_for('student.cancel_confirmation', sid=sel.id, pid=project.id) }}">
                                                        Cancel confirmation
                                                    </a>
                                                {% else %}
                                                    <a href="{{ url_for('student.request_confirmation', sid=sel.id, pid=project.id) }}">
                                                        Request confirmation
                                                    </a>
                                                {% endif %}
                                            {% else %}
                                                <a>Project available</a>
                                            {% endif %}
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    {% else %}

        <div style="text-align: center;">
            <h3> No projects available </h3>
            <hr class="intro-divider">
        </div>

    {% endif %}
{% endblock %}
