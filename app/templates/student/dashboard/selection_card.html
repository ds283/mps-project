{% from "student/macros.html" import ranked_selection %}

{% macro open_card(config, sel) %}
    <div class="alert alert-success">
        <p>Project selection for <strong>{{ config.year+1 }}&ndash;{{ config.year+2 }}</strong>
            is now available.</p>

        {# add data about deadline, if present #}
        {% if config.live_deadline %}
        <p>You can adjust your selection until the deadline
            <strong>{{ config.live_deadline.strftime("%a %d %b (%Y)") }}</strong>, which is
            <strong>{{ config.time_to_live_deadline }}</strong> from now.
        </p>
        {% endif %}
    </div>

    {% if sel.is_optional %}
        {% set optional_text = config.card_text_optional %}
        {% if optional_text and optional_text|length > 0 %}
            {{ optional_text|markdown|bclean|blinkify|safe }}
        {% else %}
            <p>
                <span style="color: red; ">This project is <strong>optional</strong> for your degree programme.</span>
                If you wish to participate, add bookmarks to keep track of the projects
                in which you are interested. Drag-and-drop your bookmarks using the drag handle
                to rank them in order of preference. Submit your selection when you are finished.
            </p>

            <p>
                <span style="color: red; ">If you do not submit a selection by the deadline, we will
                assume that you do not wish to participate.</span>
            </p>
        {% endif %}

        <p>
            Some projects may require the project supervisor to confirm that
            a pre-selection meeting has taken place, or at least been arranged,
            before the project becomes available.
        </p>
    {% else %}
        {% if sel.is_initial_selection %}
            {% set normal_text = config.card_text_normal %}
            {% if normal_text and normal_text|length > 0 %}
                {{ normal_text|markdown|bclean|blinkify|safe }}
            {% else %}
                <p>
                    This project is <strong>mandatory</strong> for your degree programme.
                    Add bookmarks to keep track of the projects in which you are interested,
                    then drag-and-drop to rank them in order of preference.
                    Submit your selection when you are finished.
                </p>
            {% endif %}

            <p>
                Some projects may require the project supervisor to confirm that
                a pre-selection meeting has taken place, or at least been arranged,
                before the project becomes available.
            </p>
        {% else %}
            {% set noninitial_text = config.card_text_noninitial %}
            {% if noninitial_text and noninitial_text|length > 0 %}
                {{ noninitial_text|markdown|bclean|blinkify|safe }}
            {% else %}
                <p>
                    If you wish to <strong>switch supervisors</strong>,
                    then add bookmarks for each project of interest.
                    Drag-and-drop your bookmarks to indicate your order of preference.
                </p>
            {% endif %}
        {% endif %}
    {% endif %}
{% endmacro %}


{% macro show_submission_status(config, sel) %}
    {% set is_valid, messages = sel.is_valid_selection %}
    <div class="row vertical-top mt-3 mb-3">
        <div class="col-12">
            <ul class="list-group" id="P{{ config.id }}-status-list">
                {% for message in messages %}
                    <li class="list-group-item {% if is_valid %}list-group-item-success{% else %}list-group-item-danger{% endif %}">{{ message }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <div class="row vertical-top mt-3 mb-3">
        <div class="col-12">
            <ul class="list-group">
                <li class="list-group-item">
                    {% if sel.has_submitted %}
                        {% if sel.has_accepted_offer %}
                            {% set offer = sel.accepted_offer %}
                            {% set project = offer.liveproject %}
                            {% if project is not none %}
                                You have accepted a custom offer for the project
                                <strong>{{ project.name }}</strong>
                                supervised by
                                <i class="fa fa-user"></i> {{ project.owner.user.name }}
                            {% else %}
                                <span class="badge badge-danger">MISSING ACCEPTED PROJECT</span>
                                <p>This is an internal error. Please contact a system administrator.</p>
                            {% endif %}
                        {% else %}
                            You have already submitted a valid list of project preferences,
                            but you may continue to revise your list up to the deadline.
                            <a href="{{ url_for('student.view_selection', sid=sel.id) }}">Show selection...</a>
                        {% endif %}
                    {% else %}
                        You have not yet submitted your project preferences.
                    {% endif %}
                </li>
                {% if sel.has_sumission_list and sel.submission_time %}
                    Last submission received at <strong>{{ sel.submission_time.strftime("%a %d %b %Y %H:%M:%S") }}</strong>.
                {% endif %}
            </ul>
        </div>
    </div>
    <div class="row vertical-top">
        <div class="col-12" style="text-align: right;">
            <div class="float-right">
                <a href="{{ url_for('student.browse_projects', id=sel.id) }}" class="btn btn-success student-dashboard-button">Show available projects...</a>
                {% if sel.has_submission_list %}
                    <a class="btn btn-secondary student-dashboard-button" href="{{ url_for('student.clear_submission', sid=sel.id) }}">
                        Clear submission
                    </a>
                {% endif %}
                <a id="P{{ config.id }}-valid-button"
                   class="btn btn-primary {% if not is_valid %}d-none{% endif %} student-dashboard-button"
                   href="{{ url_for('student.submit', sid=sel.id) }}">
                    {% if sel.has_submission_list %}Resubmit{% else %}Submit{% endif %} selection
                </a>
                <a id="P{{ config.id }}-invalid-button"
                   class="btn btn-primary disabled {% if is_valid %}d-none{% endif %} student-dashboard-button">
                    {% if sel.has_submission_list %}Resubmit{% else %}Submit{% endif %} selection
                </a>
            </div>
        </div>
    </div>
{% endmacro %}


{% macro closed_card(config, sel) %}
    <div class="alert alert-warning">
        Project selection for {{ config.year+1 }}&ndash;{{ config.year+2 }}
        is now closed.
    </div>

    {% if sel.has_submitted %}
        <div>
            {% set f = sel.selections.first() %}
            {% if f.converted_from_bookmark %}
                <p>
                    You did not submit a valid selection before the deadline, but your bookmark data was
                    used to build an approximate preference list.
                </p>
            {% else %}
                {% if sel.submission_time %}
                    <p>Your preferences were received at {{ sel.submission_time.strftime("%a %d %b %Y %H:%M:%S") }}.</p>
                {% endif %}
                <span class="badge badge-success"><i class="fa fa-check"></i> Preferences received</span>
            {% endif %}
            <a href="{{ url_for('student.view_selection', sid=sel.id) }}">Show selection...</a>
        </div>
    {% else %}
        {% if config.selection_open_to_all %}
            <p>This project was available on an <strong>opt-in basis</strong>.</p>
            <p>
                You did not submit a valid selection before the deadline,
                so we have assumed
                that you <strong>did not intend to apply</strong> to join this project.
            </p>
        {% else %}
            <p>
                You did not submit a valid selection before the deadline. You will be allocated a project
                after the main matching calculation has been performed.
            </p>
        {% endif %}
    {% endif %}

    <div class="row" style="padding-top: 8px;">
        <div class="col-12">
            <div class="float-right">
                <a href="{{ url_for('student.browse_projects', id=sel.id) }}" class="btn btn-outline-success student-dashboard-button">View the project list...</a>
            </div>
        </div>
    </div>
{% endmacro %}


{% macro render_bookmarks(config, sel) %}
    <div class="list-group" id="P{{ config.id }}-bookmarks">
        {% for bookmark in sel.ordered_bookmarks %}
        {% set project = bookmark.liveproject %}
            <div id="P{{ config.id }}-{{ project.id }}"
                 class="row vertical-top list-group-item {% if loop.index <= sel.number_choices %}selected-project{% else %}deselected-project{% endif %}">
                <div class="col-1">
                    <i class="fa fa-bars drag-handle"></i>
                    <span id="ranking" class="badge {% if loop.index <= sel.number_choices %}badge-success{% else %}badge-danger{% endif %}">#{{ loop.index }}</span>
                </div>
                <div class="col-3">
                    <a href="{{ url_for('student.view_project', sid=sel.id, pid=project.id) }}">
                        <strong>{{ project.name }}</strong>
                    </a>
                    {% if not sel.satisfies_recommended(project) %}
                        <i class="fa fa-exclamation-triangle" style="color:red;"></i>
                        <p>This project has recommended modules that are not available on your programme</p>
                    {% endif %}
                </div>
                <div class="col-2">
                    <a href="mailto:{{ project.owner.user.email }}">
                        {{ project.owner.user.name }}
                    </a>
                </div>
                <div class="col-4">
                    {% if not project.is_available(sel) %}
                        {% if project.is_waiting(sel) %}
                            <div class="dropdown student-confirm-button" style="display: inline-block;">
                                <a class="badge badge-info dropdown-toggle" data-toggle="dropdown" role="button" href="" aria-haspopup="true" aria-expanded="false">
                                    <i class="fa fa-clock-o"></i>
                                    Meeting confirmation requested
                                </a>
                                <div class="dropdown-menu">
                                    <a class="dropdown-item" href="{{ url_for('student.cancel_confirmation', sid=sel.id, pid=project.id) }}">
                                        Cancel request
                                    </a>
                                </div>
                            </div>
                        {% else %}
                            <div class="dropdown student-confirm-button" style="display: inline-block;">
                                <a class="badge badge-danger dropdown-toggle" data-toggle="dropdown" role="button" href="" aria-haspopup="true" aria-expanded="false">
                                    <i class="fa fa-exclamation-triangle"></i>
                                    Requires meeting confirmation
                                </a>
                                <div class="dropdown-menu">
                                    <a class="dropdown-item" href="{{ url_for('student.request_confirmation', sid=sel.id, pid=project.id) }}">
                                        Request confirmation
                                    </a>
                                </div>
                            </div>
                        {% endif %}
                    {% else %}
                        {% if project.is_confirmed(sel) %}
                            <span class="badge badge-success"><i class="fa fa-check"></i> Available for selection</span>
                            <span class="badge badge-primary"><i class="fa fa-check"></i> Meeting confirmed</span>
                        {% else %}
                            <span class="badge badge-success"><i class="fa fa-check"></i> Available for selection</span>
                        {% endif %}
                    {% endif %}
                </div>
                <div class="col-2">
                    <div class="float-right">
                        <a href="{{ url_for('student.remove_bookmark', sid=sel.id, pid=project.id) }}" class="badge badge-secondary">
                            <i class="fa fa-times"></i> Remove bookmark
                        </a>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% endmacro %}


{% macro selection_card(config, sel) %}
   <div class="card">
        <div class="card-header
            {% if config.selector_lifecycle == config.SELECTOR_LIFECYCLE_SELECTIONS_OPEN %}
                bg-primary text-white
            {% elif config.selector_lifecycle >= config.SELECTOR_LIFECYCLE_READY_MATCHING %} {# implies closed #}
                bg-secondary text-white
            {% else %}
                {# no markup required; formerly panel-default #}
            {% endif %}
        ">
            {% if sub %}
                <strong>Request to switch projects</strong>
            {% else %}
                <strong>Project selection</strong>
            {% endif %}
        </div>
        <div class="card-body">
            {% if config.selector_lifecycle == config.SELECTOR_LIFECYCLE_SELECTIONS_OPEN %}

                {{ open_card(config, sel) }}

                <hr class="intro-divider">
                <div class="row vertical-top">
                    <div class="col-12">
                        {% set num_choices = sel.number_choices %}
                        {% set numpl = 's' %}
                        {% if num_choices == 1 %}{% set numpl = '' %}{% endif %}
                        {% if sel.is_optional %}
                            <p>
                                Select at least <strong>{{ num_choices }}</strong> project{{ numpl }}.
                                It is not possible to guarantee that you will be assigned your highest-priority choices.
                            </p>
                        {% elif sel.is_initial_selection %}
                            <p>
                                Select at least <strong>{{ num_choices }}</strong> project{{ numpl }}.
                                It is not possible to guarantee that you will be assigned your highest-priority choices.
                            </p>
                         {% else %}
                            <p>
                                To change supervisor, select at least <strong>{{ num_choices }}</strong> project{{ numpl }}.
                            </p>
                        {% endif %}
                    </div>
                </div>

                {# render bookmarks #}
                {% if sel.has_bookmarks %}
                    {{ render_bookmarks(config, sel) }}
                {% endif %}
                {% if sel.number_custom_offers > 0 %}
                    <div class="row vertical-align">
                        <div class="col-8">
                            <strong>You have custom offers available.</strong>
                        </div>
                        <div class="col-4">
                            <div class="float-right">
                                <a href="{{ url_for('student.manage_custom_offers', sel_id=sel.id) }}" class="btn btn-secondary">Manage offers</a>
                            </div>
                        </div>
                    </div>
                {% endif %}
                {{ show_submission_status(config, sel) }}

            {% elif config.selection_closed %}

                {{ closed_card(config, sel) }}

            {% else %}
                <p>
                    Project selection for {{ config.year+1 }}&ndash;{{ config.year+2 }}
                    is not yet available.
                </p>
            {% endif %}
        </div>
    </div>

{% endmacro %}