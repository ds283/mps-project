{% extends "base_project.html" %}

{% import "bootstrap/wtf.html" as wtf %}
{% from "macros.html" import on_click_selector_field %}

{% block scripts %}
    {{ super() }}
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/latest.js?config=TeX-MML-AM_CHTML' async></script>

    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            extensions: ["tex2jax.js", "AMSmath.js"],
            jax: ["input/TeX", "output/HTML-CSS"],
            tex2jax: {
                displayMath: [ ['$$','$$'], ["\[","\]"] ],
                processEscapes: true
            },
        });
    </script>
{% endblock %}

{% block title %}
    {{ title }}
{% endblock %}

{% block content %}
    <div class="container-fluid bg-project">
        <br/>
        {% if form and show_selector %}
            <div class="well">
                <form action="{{ url_for('faculty.project_preview', id=project.id, text=text, url=url) }}" method="POST"
                      name="selector_form">
                    {{ form.hidden_tag() }}
                    {{ on_click_selector_field(form.selector, true) }}
                </form>
            </div>
        {% endif %}
        <div class="row">
            <div class="col-xs-2"></div>
            <div class="col-xs-8">
                <div class="row sm-gap-below">
                    <div class="col-xs-12 project-title">
                        {{ title }}
                    </div>
                </div>
                <div class="row sm-gap-below">
                    <div class="col-xs-6">
                        <div class="project-owner-name">{{ project.owner.user.name }}</div>
                        {% if project.owner.office %}
                            <div>{{ project.owner.office }}</div>
                        {% endif %}
                    </div>
                    <div class="col-xs-6">
                        <div class="pull-right">
                            {% if project.group %}
                                <div class="research-group-banner">{{ project.group.name }}</div>
                                {% if project.group.website and project.group.website is not none %}
                                    <a class="research-group-webpage" href="{{ project.group.website }}">
                                        Research group website <i class="fa fa-external-link"></i>
                                    </a>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                <hr class="intro-divider">

                <div class="panel panel-primary panel-primary-bg">
                    <div class="panel-heading">Project details</div>
                    <div class="panel-body">
                        <div class="panel panel-default ataglance-background">
                            <div class="panel-heading">
                                <div class="row vertical-align">
                                    <div class="col-xs-4">
                                        Key facts
                                    </div>
                                    <div class="col-xs-8">
                                        {% if sel and sel.config.selector_lifecycle == sel.config.SELECTOR_LIFECYCLE_SELECTIONS_OPEN %}
                                            <div class="pull-right">
                                                {% if sel.bookmarks.filter_by(liveproject_id=project.id).first() %}
                                                    <a href="{{ url_for('student.remove_bookmark', sid=sel.id, pid=project.id) }}"
                                                       class="btn btn-default btn-sm">
                                                        Remove bookmark
                                                    </a>
                                                {% else %}
                                                    <a href="{{ url_for('student.add_bookmark', sid=sel.id, pid=project.id) }}"
                                                       class="btn btn-default btn-sm">
                                                        Add bookmark
                                                    </a>
                                                {% endif %}
                                                {% if not project.is_available(sel) %}
                                                    {% if project.is_waiting(sel) %}
                                                        <a href="{{ url_for('student.cancel_confirmation', sid=sel.id, pid=project.id) }}"
                                                           class="btn btn-warning btn-sm">
                                                            Cancel meeting confirmation request
                                                        </a>
                                                    {% else %}
                                                        <a href="{{ url_for('student.request_confirmation', sid=sel.id, pid=project.id) }}"
                                                           class="btn btn-success btn-sm">
                                                            Request meeting confirmation
                                                        </a>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="panel-body">
                                <div class="container-fluid">
                                    {# show sign-up details if being viewed by a live student #}
                                    {% if sel %}
                                        <div class="row vertical-top">
                                            <div class="col-xs-3">Sign-up details</div>
                                            <div class="col-xs-9">
                                                <div class="sm-gap-below">
                                                    {% if project.meeting_reqd == project.MEETING_REQUIRED %}
                                                        {% if project.is_confirmed(sel) %}
                                                            <span class="label label-primary project-label"><i
                                                                    class="fa fa-check"></i> Meeting confirmed</span>
                                                        {% else %}
                                                            <span class="label label-danger project-label"><i
                                                                    class="fa fa-times"></i> Meeting required</span>
                                                        {% endif %}
                                                    {% elif project.meeting_reqd == project.MEETING_OPTIONAL %}
                                                        <span class="label label-warning project-label">Meeting optional</span>
                                                    {% else %}
                                                        <span class="label label-default project-label"><i
                                                                class="fa fa-check"></i> Meeting not required</span>
                                                    {% endif %}
                                                    {% if project.is_available(sel) %}
                                                        <span class="label label-success project-label"><i
                                                                class="fa fa-check"></i> Available</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}

                                    {% if project.show_popularity_data %}
                                        <div class="row sm-gap-below vertical-top">
                                            <div class="col-xs-3">Popularity</div>
                                            <div class="col-xs-9">
                                                {% set lab = project.format_popularity_label(['project-label']) %}
                                                {% if lab is not none %}{{ lab|safe }}{% endif %}
                                                {% set lab = project.format_bookmarks_label(['project-label']) %}
                                                {% if lab is not none %}{{ lab|safe }}{% endif %}
                                                {% set lab = project.format_selections_label(['project-label']) %}
                                                {% if lab is not none %}{{ lab|safe }}{% endif %}
                                            </div>
                                        </div>
                                    {% endif %}

                                    {% if keywords and keywords|length > 0 %}
                                        <div class="row sm-gap-below vertical-top">
                                            <div class="col-xs-3">Subject keywords</div>
                                            <div class="col-xs-9">
                                                {% for keyword in keywords %}
                                                    <span class="label label-success project-label">{{ keyword }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    {% endif %}

                                    {% if project.skills and project.skills.first() %}
                                        <div class="row sm-gap-below vertical-top">
                                            <div class="col-xs-3">Transferable skills</div>
                                            <div class="col-xs-9">
                                                {% for skill in project.ordered_skills %}
                                                    {% if skill.is_active %}
                                                        {{ skill.make_label(user_classes="project-label")|safe }}
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                    {% endif %}

                                    {% if project.programmes and project.programmes.first() %}
                                        <div class="row sm-gap-below vertical-top">
                                            <div class="col-xs-3">Prefer degree programmes</div>
                                            <div class="col-xs-9">
                                                {% for programme in project.ordered_programmes %}
                                                    {% if programme.active %}
                                                        {{ programme.make_label(user_classes="project-label")|safe }}
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                    {% endif %}

                                    {% if desc %}
                                        {% set modules = desc.ordered_modules.all() if desc is not none else none%}
                                        {% if modules and modules|length > 0 %}
                                            <div class="row sm-gap-below vertical-top">
                                                <div class="col-xs-3">Recommended modules</div>
                                                <div class="col-xs-9">
                                                    {% for module in modules %}
                                                        {% if module.active %}
                                                            {{ module.make_label(user_classes="project-label")|safe }}
                                                        {% endif %}
                                                    {% endfor %}
                                                    {% if sel and desc %}
                                                        {% if not sel.satisfies_recommended(desc) %}
                                                            <p>This project has recommended modules that are not available
                                                            on your programme. This does not prevent you from applying for
                                                            the project, but you will need to discuss its suitability
                                                            with the supervisor.</p>
                                                        {% endif %}
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% endif %}

                                    <div class="row vertical-top">
                                        <div class="col-xs-3">Supervision team</div>
                                        <div class="col-xs-9">
                                            {% if desc %}
                                                {% for role in desc.team %}
                                                    {% set style = role.make_CSS_style() %}
                                                    <span class="label label-default project-label"
                                                          {% if style %}style="{{ style }}"{% endif %}>{{ role.name }}</span>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h4>Description</h4>
                        {% if desc %}
                            <div class="project-description">{{ desc.description|dealingwithdollars|markdown|bclean|blinkify|safe }}</div>

                            {% if desc.reading and desc.reading is not none %}
                                <hr class="intro-divider">
                                <p><strong>Recommended reading</strong></p>
                                {{ desc.reading|dealingwithdollars|markdown|bclean|blinkify|safe }}
                            {% endif %}
                        {% else %}
                            <div class="alert alert-danger">
                                This combination of project and project class has no assigned description.
                                Please return to the description editor and generate a new description there.
                            </div>
                        {% endif %}
                    </div>
                </div>

                {% if allow_approval %}
                    <hr class="intro-divider">
                    <div class="row">
                        <div class="col-xs-12">
                            <a href="{{ url_for('project_approver.approve', id=desc.id, url=url, text=text) }}" class="btn btn-success">
                                <i class="fa fa-check"></i> Approve
                            </a>
                            <a href="{{ url_for('project_approver.reject', id=desc.id, url=url, text=text) }}" class="btn btn-danger">
                                <i class="fa fa-times"></i> Reject
                            </a>
                        </div>
                    </div>
                {% else %}
                    {% if text and url %}
                        <a href="{{ url }}">
                            <i class="fa fa-backward"></i> Return to {{ text }}
                        </a>
                    {% endif %}
                {% endif %}
            </div>

        </div>
        <div class="col-xs-2"></div>
    </div>

    <nav class="navbar navbar-default navbar-fixed-bottom" role="navigation">
        <div class="navbar-header footer-bar">
            <p class="copyright text-muted small">Copyright (c) {{ website_copyright_dates }} University of Sussex</p>
        </div>
    </nav>
{% endblock %}
